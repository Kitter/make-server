#              _                ___            _        
#  _ __   __ _(_)_ __ __  __   / / |_ __ _ ___| | _____ 
# | '_ \ / _` | | '_ \\ \/ /  / /| __/ _` / __| |/ / __|
# | | | | (_| | | | | |>  <  / / | || (_| \__ \   <\__ \
# |_| |_|\__, |_|_| |_/_/\_\/_/   \__\__,_|___/_|\_\___/
#        |___/                                          
#                            _ _                         
#   ___ ___  _ __ ___  _ __ (_) | ___       ___ _ __ ___ 
#  / __/ _ \| '_ ` _ \| '_ \| | |/ _ \_____/ __| '__/ __|
# | (_| (_) | | | | | | |_) | | |  __/_____\__ \ | | (__ 
#  \___\___/|_| |_| |_| .__/|_|_|\___|     |___/_|  \___|
#                     |_|                                
- name: '(REBUILD) make clean'
  command: >
    make clean
    chdir={{ local.src }}/nginx-{{ nginx.version }}/
    removes=Makefile
  when: nginx.rebuild == 1

- name: 'Be sure nginx {{ nginx.version }} has been configured'
  notify: Restart nginx
  command: >
    /bin/sh configure
    --prefix={{ nginx.serverroot }}
    --with-ld-opt=-L/usr/local/lib
    --with-http_ssl_module
    --with-http_gzip_static_module
    --without-http_ssi_module
    --without-http_autoindex_module
    --without-http_geo_module
    --without-http_fastcgi_module
    --without-http_uwsgi_module
    --without-http_memcached_module
    --without-mail_pop3_module
    --without-mail_imap_module
    --without-mail_smtp_module
    --with-http_stub_status_module
    creates=Makefile
    chdir={{ local.src }}/nginx-{{ nginx.version }}/

- name: 'make nginx {{ nginx.version }}'
  notify: Restart nginx
  command: >
    make
    chdir={{ local.src }}/nginx-{{ nginx.version }}/
    creates=objs/nginx
  register: make_nginx_binary

- name: 'Be sure nginx {{ nginx.version }} is installed'
  when: make_nginx_binary.changed
  notify: Restart nginx
  command: >
    make install
    chdir={{ local.src }}/nginx-{{ nginx.version }}/

